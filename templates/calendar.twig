{% extends "_layouts/default.twig" %}

{% block bodyTag %}
  {{ parent()|attr({
    class: 'bg-[#1D1D1D]'
  }) }}
{% endblock %}

{% set start = now|atom %}

{% block content %}
{% block header %}{% include '_partials/header.twig' %}{% endblock %}
<style>
  .fc-daygrid-block-event .fc-event-title {
    padding: 8px;
  }
  a.fc-daygrid-event {
    white-space: normal;
  }
  table {
    margin-bottom: 0;
  }
</style>
<div class="bg-white">
  <div class="max-w-screen-xl min-w-screen-xl mx-auto px-6 md:px-0">
    <div class="mt-8 mb-24"
        x-data="{
            calendar: null,
            events: [
                {% set evId = 0 %}
                {% for product in craft.products.orderBy('expiryDate DESC') %}
                {% if product.eventDates != null %}
                    {% for evDate in product.eventDates %}
                      {{ '{ id: ' ~ evId ~ ',
                            title:\'' ~ product.type.name ~ ' - ' ~ product.title ~ '\',
                            start: \'' ~ evDate.theEventDate|date('Y-m-j') ~ '\',
                            url: \'' ~ product.type.handle ~ '\','
                          ~ '},'}}
                      {% set evId = evId + 1 %}
                    {% endfor %}
                {% endif %}
                {% endfor %}
            ],
            init() {
                this.calendar = new FullCalendar.Calendar(this.$refs.calendar, {
                    events: (info, success) => success(this.events),
                    eventColor: '#006B36',
                    initialDate: '{{now|date('Y-m-j')}}',
                    initialView: 'dayGridMonth',
                    selectable: false,
                    unselectAuto: false,
                    editable: false,
                    fixedWeekCount: false,
                })
    
                this.calendar.render()
            },
            getEventIndex(info) {
                return this.events.findIndex((event) => event.id == info.event.id)
            },
            addEvent() {
                if (! this.newEventTitle || ! this.newEventStart) {
                    return alert('Please choose a title and start date for the event!')
                }
    
                let event = {
                    id: Date.now(),
                    title: this.newEventTitle,
                    start: this.newEventStart,
                    end: this.newEventEnd,
                }
    
                this.events.push(event)
                this.calendar.refetchEvents()
    
                this.newEventTitle = null
                this.newEventStart = null
                this.newEventEnd = null
    
                this.calendar.unselect()
            },
        }"
    >
        <div x-ref="calendar"></div>
    
        <h2 class="mt-8 font-bold">Upcoming Events</h2>
        <ul class="mt-1 list-inside list-disc text-sm text-gray-500">
        {% for product in craft.products.all() %}
          {% if product.type.handle != 'membership' %}
          <li><a href="/{{product.type.handle}}">{{ product.type.name }} â€“ {{ product.title }}</a></li>
          {% endif %}
        {% endfor %}
        </ul>
    </div>
  </div>
</div>
{% block apics_cta %}{% include '_partials/apics_cta.twig' %}{% endblock %}
{% block footer %}{% include '_partials/footer.twig' %}{% endblock %}
{% endblock %}
